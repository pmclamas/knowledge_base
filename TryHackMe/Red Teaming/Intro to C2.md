Command and Control (C2) Frameworks are an essential part of both Red Teamers and Advanced Adversaries playbooks. They make it both easy to manage compromised devices during an engagement and often help aid in lateral movement.

##### Command and Control Framework structure
**What is a Command and Control Framework**
In order to better understand what a C2 framework is at its most basic level, think of a Netcat listener (the C2 server) that is capable of handling many reverse shells calling back at once (C2 Agents). It's a server but for reverse shells. Unlike Netcat, almost all C2 frameworks require a special payload generator.
This is usually a feature that is built into the framework itself. For example, Metasploit is a C2 Framework that has its own payload generator, MSFVenom.

**Command and Control Structure**
***C2 Server -*** the C2 Server serves as a hub for agents to call back to. Agents will periodically reach out to the C2 server and wait for the operator's commands.
***Agents/Payloads -*** an agent is a program generated by the C2 framework that calls back to a listener on a C2 server. Most of the time, this agent enables special functionality compared to a standard reverse shell. It's important to know that agents can be highly configurable, with adjustments on the timing of how often C2 Agents beacon out to a Listener on a C2 Server and much more.
***Listeners -*** on the most basic level, a listener is an application running on the C2 server that waits for a callback over a specific port or protocol. Some examples of this are DNS, HTTP, and or HTTPS.
***Beacons -*** a Beacon is the process of a C2 Agent calling back to the listener running on a C2 Server.

**Obfuscating Agent Callbacks**
***Sleep Timers -*** one key thing that some security analysts, anti-virus, and next-generation firewalls look for when attempting to identify Command and Control traffic is beaconing and the rate at which a device beacons out to a C2 server.
	***Jitter -*** jitter takes the sleep timer and adds some variation to it; our C2 beaconing may now exhibit a strange pattern that may show activity that is closer to an average user. The beaconing is now set at a semi-irregular pattern that makes it slightly more difficult to identify among regular user traffic.
In more advanced C2 frameworks, it may be possible to alter various other parameters, like "File" jitter or adding junk data to the payload or files being transmitted to make it seem larger than it actually is.
	
	Sample Python3 code for Jitter may look like:
		import random
		sleep = 60
		jitter = random.randint(-30,30)
		sleep = sleep + jitter
It's important to note that this is a fundamental example, but it can be much more math-heavy, setting upper bounds and lowe bounds, taking percentages of last sleep, and building on from there.

**Payload Types**
Much like a regular Reverse Shell, there are two primary types of payloads that you may be able to use in your C2 Framework; Staged and Stageless payloads.
- ***Stageless Payloads -*** are the simplest, they contain the full C2 agent and will call back to the C2 server and begin beaconing immeditately. 
  *The steps for establishing C2 beaconing with a Stageless payload are as follows:*
  1. The Victim downloads and executes the Dropper
  2. The beaconing to the C2 Server begins
- ***Staged Payloads -*** require a callback to the C2 Server to download additional parts of the C2 agent. This is commonly referred to as a "Dropper" because it is "Dropped" onto the victim machine to download the second stage of our staged payload. This is a preferred method over stageless payloads because a small amount of code needs to be written to retrieve the additional parts of the C2 agent from the C2 Server. It also makes it easier to obfuscate code to bypass Anti-virus programs.
  *The steps for establishing C2 beaconing with a Staged payload are as follows:*
  1. The Victim downloads and executes the Dropper
  2. The Dropper calls back to the C2 Server for Stage 2
  3. The C2 Server sends Stage 2 back to the Victim Workstation
  4. Stage 2 is loaded into memory on the Victim Workstation
  5. C2 Beaconing initializes, and the Red Teamer/Threat Actors can engage with the Victim on the C2 Server.

**Payload Formats**
Windows PE files (Executables) are not the only way to execute code on a system. Some C2 Frameworks support payloads in various other formats:
- PowerShell Scripts
- HTA Files
- JScript Files
- Visual Basic Application/Scripts
- Microsoft Office Documents
- ...and may more.

**Modules**
Modules are a core component of any C2 Framework; they add the ability to make agents and the C2 server more flexible.
	***Post Exploitation Modules -*** are simply modules that deal with anything after the initial point of compromise, this could be as simple as running SharpHound.ps1 to find paths of lateral movement, or it could be as complex as dumping LSASS and parsing credentials in memory.
	***Pivoting Modules -*** one of the last major components of a C2 Framework is its pivoting modules, making it easier to access restrited network segments within the C2 Framework. If you have Administrative Access on a system, you may be able to open up an "SMB Beacon", which can enable a machine to act as a proxy via the SMB protocol. This may allow machines in a restricted network segment to communicate with your C2 server.

**Facing the world**
One important obstacle that all Red Teamers must overcome is placing infrastructure in plain view. There are many different methods to do this; one of the most popular methods is called "Domain Fronting".
- ***Domain Fronting -*** utilizes a known, good host (Cloudflare, for example). Cloudfare runs a business that provides enhanced metrics on HTTP connection details as well as caching HTTP connection requests to save bandwidth. Red Teamers can abuse this to make it appear that a workstation or server is communicating with a known, trusted IP Address. Geolocation results will show wherever the nearest Cloudflare server is, and the IP Address will show as ownership to Cloudflare.
  ![[Screenshot 2022-09-12 at 11.45.02.png]]
- ***C2 Profiles -*** all of the proxy features more or less allow a user to control specific elements of the incoming HTTP request. 
  Because HTTPS requests are encrypted, extracting specific headers (ex: X-C2-Server, or Host) may be impossible. By using C2 Profiles, we may be able to hide our C2 Server from the prying eyes of a Security Analyst. 

##### Common C2 Frameworks
- Metasploit
- Armitage
- Powershell Empire
- Covenant
- Sliver
- Cobalt Strike (paid)
- Brute Ratel (paid)

##### C2 Operation Basics
**Accessing and Managing your C2 infrastructure**
	***Basic Operational Security***
	You should never have your C2 management interface directly accessible. It can be incredibly easy to fingerprint C2 servers.
	The point in mentioning this is that you want to reduce your operational security risk as much as possible.
	***Accessing your Remote C2 Server that's listening locally***
	SSH port-forwarding allows us to either host resources on a remote machine by forwarding a local port to the remote server, or allows us to access local resources on the remote machine we are connecting to. In some circumstances, this may be for circumventing Firewalls.
	Or, in our instance, this could be done for operational security reasons.
	![[Screenshot 2022-09-13 at 10.16.00.png]]
	We highly recommend putting firewall rules in place for C2 servers that must listen on a public interface so only the intended users can access your C2 server. There are various ways to do this. If you are hosting Cloud Infrastructure, you can set up a Security Group or use a host-based firewall solution like UFW or IPTables.

**Listener Type**
Standard reverse shell listeners are not the only ones that exist; there are many varieties that use many different protocols; however, there are a few common ones that we will cover:
	***Standard Listener -*** these often communicate directly over a raw TCP or UDP socket, sending commands in cleartext. Metasploit has full support for generic listeners.
	***HTTP/HTTPS listeners -*** these often front as some sort of Web Server and use techniques like Domain Fronting or Malleable C2 profiles to mask a C2 server. When specifically communicating over HTTPS, it's less likely for communications to be blocked by an NGFW. Metasploit has full support for HTTP/HTTPS listeners.
	***DNS Listener -*** popular technique specifically used in the exfiltration stage where additional infrastructure is normally required to be set up, or at the very least, a Domain Name must be purchased and registered, and a public NS server must be configured. It is possible to set up DNS C2 operations in Metasploit with the help of additional tools. 
	***SMB Listener -*** communicating via SMB named pipes is a popular method of choice, especially when dealing with a restricted network; it often enables more flexible pivoting with multiple devices talking to each other and only one device reaching back out over a more common protocol like HTTP/HTTPS. Metasploit has support for Named Pipes.

##### Advanced C2 Setups
**There's always room for improvement**
Metasploit itself is not that great of a C2 server for advanced adversary operations. It's not as flexible as one would desire; you cannot configure agents to beacon out every X seconds with Y jitter. A next-generation firewall could quickly pick up on this C2 traffic, seeing it's a constant stream of traffic. In addition, anyone could connect to an HTTP/HTTPS listener and find out relatively quickly what is going on.

**Command and Control Redirectors**
***What is a Redirector?***
It's a server that "Redirects" HTTP/HTTPS requests based on information within the HTTP Request body. In production systems, you may see a "Redirector" in the form of a Load Balancer. This server often runs Apache 2 or NGINX. For this lab, we will be leveraging Apache and some of its modules to build a Redirector.

Jumping back into Metasploit, we can set up some basic configurations on Metasploit to allow for more advanced configurations.
Usually, this configuration is set up on multiple hosts; the purpose of this is to hide the true Command and Control server.

Usually, when you have a C2 callback, you may set the callback host to a domain. It's very common for your C2 server to get reported, when a user files a complaint. Usually, the server gets taken down fairly quickly. Setting up a redirector ensures that any information you may have collected during the engagement is safe and sound.


